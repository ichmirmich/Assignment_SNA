---
title: "troll wip1"
author: "Johannes Kopf"
date: "24 November 2018"
output: pdf_document
---

https://golovchenko.github.io/tutorials/snatrolls.html

Aus 538-Artikel:
"If you use the data and find anything interesting, please let us know. Send your projects to oliver.roeder@fivethirtyeight.com or @ollie."

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(igraph)
library(dplyr)
library(readr)
library(knitr)
```

```{r, include=F}
## loading the data and setting working directory
setwd("C:/Google Drive/Universität/Master/Kopenhagen/Social Network Analysis/Troll-Data")
tweets <- read.csv("C:/Google Drive/Universität/Master/Kopenhagen/Social Network Analysis/Troll-Data/tweets.csv", stringsAsFactors = F, sep = ",")
tweets_538 <- read.csv
```

```{r, include=F}
## how many tweets?
print(paste("Read ", length(tweets$text), " tweets.", sep=""))
```

```{r, inlcude=F}
## loading the 538 twitter data for later comparison of account categories
tweets1 <- read.csv("Raw Data/IRAhandle_tweets_1.csv", stringsAsFactors = F, sep = ",")
tweets2 <- read.csv("Raw Data/IRAhandle_tweets_2.csv", stringsAsFactors = F, sep = ",")
tweets3 <- read.csv("Raw Data/IRAhandle_tweets_3.csv", stringsAsFactors = F, sep = ",")
tweets4 <- read.csv("Raw Data/IRAhandle_tweets_4.csv", stringsAsFactors = F, sep = ",")
tweets5 <- read.csv("Raw Data/IRAhandle_tweets_5.csv", stringsAsFactors = F, sep = ",")
tweets6 <- read.csv("Raw Data/IRAhandle_tweets_6.csv", stringsAsFactors = F, sep = ",")
tweets7 <- read.csv("Raw Data/IRAhandle_tweets_7.csv", stringsAsFactors = F, sep = ",")
tweets8 <- read.csv("Raw Data/IRAhandle_tweets_8.csv", stringsAsFactors = F, sep = ",")
tweets9 <- read.csv("Raw Data/IRAhandle_tweets_9.csv", stringsAsFactors = F, sep = ",")
tweets10 <- read.csv("Raw Data/IRAhandle_tweets_10.csv", stringsAsFactors = F, sep = ",")
tweets11 <- read.csv("Raw Data/IRAhandle_tweets_11.csv", stringsAsFactors = F, sep = ",")
tweets12 <- read.csv("Raw Data/IRAhandle_tweets_12.csv", stringsAsFactors = F, sep = ",")
tweets13 <- read.csv("Raw Data/IRAhandle_tweets_13.csv", stringsAsFactors = F, sep = ",")
tweets_538 <- rbind(tweets1, tweets2, tweets3 , tweets4, tweets5, tweets6, tweets7, tweets8, tweets9,tweets10, tweets11, tweets12, tweets13)
```


```{r, include=F}
## extracting handle variable and account_type variabe and removing duplicates
myvars <- c("author", "account_type") 
account_type <- tweets_538[myvars] %>% unique()

## making variable name identical
tweets <- tweets %>% rename(handle = user_key)
account_type <- account_type %>% rename(handle = author)

## adding account_type variable to the NBC dataset
account_type$handle <- tolower(account_type$handle)
tweets <- left_join(tweets, account_type)
```

```{r, include=F}
## Code of Yevgeniy Golovchenko: https://golovchenko.github.io/tutorials/snatrolls.html
## selecting only the retweets
rts <- grep("^rt @[a-z0-9_]{1,15}", tolower(tweets$text), perl=T, value=T)

## extracting handle names for the senders (those who retweet)
rt.sender <- tolower(as.character(tweets$handle[grep("^rt @[a-z0-9_]{1,15}", tolower(tweets$text), perl=T)]))

## extracting handle names for the recievers (those who are being retweeted)
rt.receiver<- tolower(regmatches(rts, regexpr("@(?U).*:", rts)))
rt.receiver <- (gsub(":", "", rt.receiver)) ## removing ":"
rt.receiver <- (gsub("@", "", rt.receiver)) ## removing "@"

## Registering empty entries as missing
rt.sender[rt.sender==""] <- "<NA>"
rt.receiver[rt.receiver==""] <- "<NA>"
```

```{r, include=F}
## storing reciever and sender handle names in one dataframe and removing duplicates
handles_all <- unique(as.data.frame(c(rt.sender, rt.receiver))) %>% rename(handle = "c(rt.sender, rt.receiver)")

## There are 36.889 unique handles in the retweet dataset
```

```{r, include=F}
## importing handle names from the official list release in congress
trolls_official <-  read.csv("http://golovchenko.github.io/data/trollhandles.txt", stringsAsFactors = F)

## merging the complete list of official troll handle names with the handle names in NBC data
handles <- tweets %>% select(handle) %>% unique() ## all individuals who tweeted or retweeted, without the ones who were retweeted -> 453 handles

handles_comparison <- rbind(trolls_official, handles) %>% unique() ## adding all of the official troll handles and removing duplicates
handles_comparison$troll <- "troll" ## assigning all of these users a trolls

## matching trolls with the complete set of handle names in the retweet network
nodes <- right_join(handles_comparison, handles.all)

length(na.omit(nodes$troll)) ## there are 389 trolls in the retweet network, either retweeting or being retweeted

length(nodes$troll) - (length(na.omit(nodes$troll))) ## there are 36500 non-trolls in the retweet dataset

nodes <- replace(nodes, is.na(nodes), "non-troll") ## now we have a variable indicating wether a user is a troll

nodes_categorized <- left_join(nodes, account_type)
```

```{r, include=F}
handles_categ <- left_join(handles.u, account_type.u) %>%
  na.omit(handles_categ)

troll_nodes <- na.omit(nodes)
```


```{r, include=F}
### Creating a data frame from the sender-receiver objects
rts.df <- data.frame(rt.sender, rt.receiver)
### creating the retweetnetwork based on the sender-receiver df and the node attributes (troll/non-troll)
rts.g <- graph.data.frame(rts.df, directed=T, vertices = nodes)
### removing self-ties
rts.g <-simplify(rts.g, remove.loops = T, remove.multiple = F)
```

```{r, include=F}
## creating the retweetnetwork based on the sender-receiver df and the node attributes (troll/non-troll)
rts.g <- graph.data.frame(rts.df, directed=T, vertices = nodes)
## removing self-ties
rts.g <-simplify(rts.g, remove.loops = T, remove.multiple = F)
```

```{r, include=F}
## removing multiple edges between users
g <- simplify(rts.g, remove.multiple = T, remove.loops = T)
## creating a data frame with weighted and unweighted degree centrality for each profile
df <- data.frame(name =V(g)$name,
                 troll= V(g)$troll,indegree=degree(g,mode='in'),
                 indegree_weighted = degree(rts.g, mode ="in"),
                 outdegree=degree(g,mode='out'),
                 outdegree_weighted = degree(rts.g, mode = "out"))
## ranking users by indegree
rank.indegree <- df %>% select(name, troll, indegree,
                          indegree_weighted) %>% arrange(-indegree)
```

```{r, inlude=F}
#ranking users b weigted indegree n users * n retweets
rank.indegree.w <- df %>% select(name, troll, indegree,
                          indegree_weighted) %>% arrange(-indegree_weighted)
```

```{r, echo=F}
kable(rank.indegree[1:10,], caption = "Top 10 profiles ranked by indegree")
```

```{r, echo=F}
kable(rank.indegree.w[1:10,], caption = "Top 10 profiles ranked by weighted indegree")
```

```{r, echo=F}
### subsetting the graph by removing non-trolls
#selecting nodes to exclude
exclude <- V(rts.g)[troll == "non-troll"]
#excluding the nodes
g.troll <- delete.vertices(rts.g, exclude)

### vizualizing the graph
par(bg ="grey10")
plot.igraph(g.troll,layout= layout.fruchterman.reingold(g.troll),
            edge.color="grey",
            edge.curved= .2, vertex.label = NA, vertex.frame.color="#ffffff",
            vertex.size = 2, edge.size = 0.01, edge.arrow.size = 0.01)
```

```{r, echo=F}
#decomposing the graph into components and returning the largest one
comp <- decompose(g.troll, mode = c("weak"), max.comps = 1,
                  min.vertices = 1)
### plotting the graph
par(bg ="grey10")
plot.igraph(comp[[1]],layout= layout.fruchterman.reingold(comp[[1]]),
            edge.color="grey",
            edge.curved= .2, vertex.label = NA, vertex.frame.color="#ffffff",
            vertex.size = 4, edge.size = 0.005, edge.arrow.size = 0.01)
```

```{r, inlcude=F}
#exporting the rts.g graph object as a graphml file 
write.graph(rts.g, file="troll_network.graphml", format="graphml")
```

